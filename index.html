<!DOCTYPE html>
<html lang="en">
<head>
     <!--PropellerAds-->
    <script src="https://fpyf8.com/88/tag.min.js" data-zone="157210" async data-cfasync="false"></script>

    <script type='text/javascript' src='//pl26717244.profitableratecpm.com/bf/51/a4/bf51a42d984554beaaed4a58dcdb733d.js'></script>
    <script type='text/javascript' src='//pl26713337.profitableratecpm.com/64/66/f1/6466f1b7fea6c93f404f4ab49960b99c.js'></script>
    <script async="async" data-cfasync="false" src="//pl26713372.profitableratecpm.com/1a6d5fbc149d94ff8c697b1327966995/invoke.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinEarner Pro - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        accent: {
                            400: '#f59e0b',
                            500: '#d97706',
                            600: '#b45309'
                        },
                        success: {
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark .glass {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .dark .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }
        
        .dark .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            max-width: 600px;
            width: 95%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .hidden { display: none !important; }
        
        .admin-card {
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .user-row {
            transition: all 0.2s ease;
        }
        
        .user-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .verified {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .unverified {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .inactive {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }
        
        .input-base {
            font-size: 16px;
        }
        
        .permission-badge {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin: 2px;
        }
        
        .readonly-field {
            background: rgba(156, 163, 175, 0.2);
            cursor: not-allowed;
        }
        
        .editable-field {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }
        
        .restricted-field {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }
    </style>
</head>
<body class="gradient-bg text-white overflow-x-hidden">
    <!-- Navigation Header -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-shield-alt text-3xl text-blue-400"></i>
                        <span class="text-xl font-bold">Admin Panel</span>
                    </div>
                    <div class="permission-badge">
                        <i class="fas fa-user-shield mr-1"></i>Limited Admin
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="adminInfo" class="hidden flex items-center space-x-4">
                        <div class="text-right">
                            <div class="font-semibold" id="adminName">Admin</div>
                            <div class="text-xs text-white/70" id="adminEmail">admin@example.com</div>
                        </div>
                        <button onclick="adminLogout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                    <button onclick="showLoginModal()" id="loginButton" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg transition-all">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Login Required Message -->
        <div id="loginRequired" class="text-center py-20">
            <div class="glass rounded-3xl p-8 max-w-md mx-auto">
                <i class="fas fa-lock text-6xl text-blue-400 mb-4"></i>
                <h2 class="text-2xl font-bold mb-4">Admin Login Required</h2>
                <p class="text-white/80 mb-6">Please login with your registered account credentials to access the admin panel.</p>
                <button onclick="showLoginModal()" class="bg-blue-500 hover:bg-blue-600 px-8 py-3 rounded-lg font-semibold transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login Now
                </button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
            <!-- Dashboard Header -->
            <div class="glass rounded-2xl p-6 mb-8">
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold mb-2">Welcome to Admin Panel</h1>
                        <p class="text-white/80">Limited administrative access for user management</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-white/70">Last Login</div>
                        <div class="font-semibold" id="lastLoginTime">Just now</div>
                    </div>
                </div>
            </div>

            <!-- Admin Permissions Info -->
            <div class="glass rounded-2xl p-6 mb-8">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-key text-yellow-400 mr-2"></i>
                    Your Admin Permissions
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check text-green-400"></i>
                        <span>Search Users</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-edit text-blue-400"></i>
                        <span>Edit Limited Fields</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-coins text-yellow-400"></i>
                        <span>Manage Coins (Decrease Only)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-gem text-cyan-400"></i>
                        <span>Manage Diamonds</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-times text-red-400"></i>
                        <span>No Personal Data Access</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-times text-red-400"></i>
                        <span>No Password Access</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-times text-red-400"></i>
                        <span>No Financial Data</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-times text-red-400"></i>
                        <span>No User Deletion</span>
                    </div>
                </div>
            </div>

            <!-- User Search -->
            <div class="glass rounded-2xl p-6 mb-8">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-search text-blue-400 mr-2"></i>
                    User Search & Management
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <input type="text" id="userSearchInput" placeholder="Search by email..." class="glass-input rounded-lg px-4 py-2 text-white input-base">
                    <button onclick="searchUser()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <button onclick="clearSearch()" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-times mr-2"></i>Clear
                    </button>
                    <button onclick="loadAllUsers()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-users mr-2"></i>Load All
                    </button>
                </div>
                
                <!-- User Results -->
                <div id="userResults" class="mt-6">
                    <div class="text-center text-white/70 py-8">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>Search for users using their email address</p>
                    </div>
                </div>
            </div>

            <!-- Recent Admin Activity -->
            <div class="glass rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-history text-purple-400 mr-2"></i>
                    Recent Admin Activity
                </h3>
                <div id="adminActivity" class="space-y-3">
                    <div class="p-3 bg-white/10 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span>Admin panel accessed</span>
                            <span class="text-xs text-white/60">Just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay hidden" id="loginModal">
        <div class="modal-content glass rounded-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-sign-in-alt text-blue-400 mr-2"></i>
                    Admin Login
                </h2>
                <button onclick="hideModal('loginModal')" class="text-white/60 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6 p-4 bg-blue-500/20 rounded-lg border border-blue-500/30">
                <div class="flex items-center mb-2">
                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                    <span class="font-semibold">Admin Access Requirements</span>
                </div>
                <ul class="text-sm text-white/80 space-y-1">
                    <li>• Must be registered in the main CoinEarner Pro app</li>
                    <li>• Email and password must match your app account</li>
                    <li>• Valid admin authorization code required</li>
                </ul>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="loginEmail" required class="w-full px-4 py-3 glass-input rounded-xl text-white placeholder-white/50 input-base" placeholder="Enter your registered email">
                </div>
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" required class="w-full px-4 py-3 glass-input rounded-xl text-white placeholder-white/50 input-base" placeholder="Enter your app password">
                </div>
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Admin Authorization Code</label>
                    <input type="text" id="adminCode" required class="w-full px-4 py-3 glass-input rounded-xl text-white placeholder-white/50 input-base" placeholder="Enter admin code">
                    <small class="text-white/60 text-xs">Contact system administrator for admin authorization</small>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-xl hover:from-blue-600 hover:to-purple-700 font-semibold transition-all">
                    Login to Admin Panel
                </button>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div class="modal-overlay hidden" id="userEditModal">
        <div class="modal-content glass rounded-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-user-edit text-green-400 mr-2"></i>
                    Edit User: <span id="editUserName">User</span>
                </h2>
                <button onclick="hideModal('userEditModal')" class="text-white/60 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6 p-4 bg-yellow-500/20 rounded-lg border border-yellow-500/30">
                <div class="flex items-center mb-2">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
                    <span class="font-semibold">Important Notice</span>
                </div>
                <p class="text-sm text-white/80">You can only modify specific fields. Some restrictions apply to protect user data.</p>
            </div>
            
            <form id="userEditForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                
                <!-- Editable Fields with Restrictions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Coins (Decrease Only) -->
                    <div class="restricted-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">
                            <i class="fas fa-coins text-yellow-400 mr-1"></i>
                            Coins (Decrease Only)
                        </label>
                        <input type="number" id="editCoins" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base" min="0">
                        <small class="text-yellow-400 text-xs">Cannot increase coins, only decrease</small>
                    </div>
                    
                    <!-- Diamonds (Full Control) -->
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">
                            <i class="fas fa-gem text-cyan-400 mr-1"></i>
                            Diamonds
                        </label>
                        <input type="number" id="editDiamonds" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base" min="0">
                        <small class="text-cyan-400 text-xs">Can increase or decrease</small>
                    </div>
                    
                    <!-- Earnings (Decrease Only) -->
                    <div class="restricted-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">
                            <i class="fas fa-money-bill-wave text-green-400 mr-1"></i>
                            Earnings (Decrease Only)
                        </label>
                        <input type="number" id="editEarnings" step="0.01" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base" min="0">
                        <small class="text-yellow-400 text-xs">Cannot increase earnings</small>
                    </div>
                    
                    <!-- Streak -->
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">
                            <i class="fas fa-fire text-red-400 mr-1"></i>
                            Login Streak
                        </label>
                        <input type="number" id="editStreak" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base" min="0">
                        <small class="text-blue-400 text-xs">Can modify streak count</small>
                    </div>
                    
                    <!-- Achievement Points -->
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">
                            <i class="fas fa-trophy text-purple-400 mr-1"></i>
                            Achievement Points
                        </label>
                        <input type="number" id="editAchievementPoints" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base" min="0">
                    </div>
                    
                    <!-- Preferred Language -->
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">
                            <i class="fas fa-language text-indigo-400 mr-1"></i>
                            Preferred Language
                        </label>
                        <select id="editLanguage" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base">
                            <option value="en">English</option>
                            <option value="bn">Bangla</option>
                            <option value="hi">Hindi</option>
                            <option value="ur">Urdu</option>
                        </select>
                    </div>
                </div>
                
                <!-- Account Status Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">Account Status</label>
                        <select id="editIsActive" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">Daily Games Unlocked</label>
                        <select id="editDailyGames" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">Daily Videos Unlocked</label>
                        <select id="editDailyVideos" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                
                <!-- Profile Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">Bio</label>
                        <textarea id="editBio" rows="3" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base"></textarea>
                    </div>
                    
                    <div class="editable-field p-3 rounded-lg">
                        <label class="block text-white/80 text-sm font-medium mb-2">Location</label>
                        <input type="text" id="editLocation" class="w-full px-3 py-2 glass-input rounded-lg text-white input-base">
                    </div>
                </div>
                
                <!-- Read-Only Fields -->
                <div class="mt-6">
                    <h4 class="font-semibold mb-3 text-white/80">
                        <i class="fas fa-eye text-gray-400 mr-2"></i>
                        View Only Fields
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="readonly-field p-3 rounded-lg">
                            <label class="block text-white/60 text-sm mb-1">Gender</label>
                            <span id="viewGender" class="text-white">-</span>
                        </div>
                        <div class="readonly-field p-3 rounded-lg">
                            <label class="block text-white/60 text-sm mb-1">Join Date</label>
                            <span id="viewJoinDate" class="text-white">-</span>
                        </div>
                        <div class="readonly-field p-3 rounded-lg">
                            <label class="block text-white/60 text-sm mb-1">Last Login</label>
                            <span id="viewLastLogin" class="text-white">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 font-semibold transition-all">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="hideModal('userEditModal')" class="flex-1 glass text-white py-3 px-6 rounded-xl hover:bg-white/20 font-semibold transition-all">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal-overlay hidden" id="customAlert">
        <div class="modal-content glass rounded-2xl p-8 text-center">
            <i id="alertIcon" class="fas fa-info-circle text-5xl mb-4"></i>
            <p id="alertMessage" class="text-xl mb-6 text-white"></p>
            <button onclick="hideCustomAlert()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-xl hover:from-blue-600 hover:to-purple-700 font-semibold transition-all">
                OK
            </button>
        </div>
    </div>

    <script>
        // Enhanced Admin Panel System
        const config = {
            apiEndpoint: 'https://script.google.com/macros/s/AKfycbwzeoNtCleXecmpyEpfQMiZxNHizvl84nUipSj1FxTySFVhQrT-3K9Oo_7FiidM5HPL/exec',
            appVersion: '3.0.0'
        };

        class AdminPanelManager {
            constructor() {
                this.currentAdmin = null;
                this.isLoggedIn = false;
                this.validAdminCodes = ['ADMIN2024', 'MANAGER2024', 'SUPPORT2024']; // These should be stored on server
                this.permissions = {
                    canDecreaseCoins: true,
                    canIncreaseCoins: false,
                    canManageDiamonds: true,
                    canDecreaseEarnings: true,
                    canIncreaseEarnings: false,
                    canEditProfile: true,
                    canViewPersonalData: false,
                    canDeleteUsers: false
                };
                this.originalUserData = {}; // Store original data for validation
                this.init();
            }

            init() {
                this.loadAdminSession();
                this.setupEventListeners();
                this.updateUI();
            }

            loadAdminSession() {
                const session = localStorage.getItem('adminSession');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.expires > Date.now()) {
                            this.currentAdmin = sessionData.admin;
                            this.isLoggedIn = true;
                        } else {
                            localStorage.removeItem('adminSession');
                        }
                    } catch (e) {
                        localStorage.removeItem('adminSession');
                    }
                }
            }

            saveAdminSession() {
                if (this.currentAdmin) {
                    const sessionData = {
                        admin: this.currentAdmin,
                        expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                    };
                    localStorage.setItem('adminSession', JSON.stringify(sessionData));
                }
            }

            async verifyUser(email, password) {
                try {
                    // Load user data from main app database
                    const filename = email.replace('@', '_at_').replace(/\./g, '_dot_') + '.json';
                    const response = await fetch(`${config.apiEndpoint}?folder=users&filename=${filename}`);
                    
                    if (!response.ok) {
                        return { success: false, message: 'User not found in system' };
                    }
                    
                    const text = await response.text();
                    if (text.includes('error') || text.includes('not found')) {
                        return { success: false, message: 'User not registered in main app' };
                    }
                    
                    const userData = JSON.parse(text);
                    
                    // In real implementation, you would verify password hash
                    // For demo, we'll assume password verification passes
                    return { success: true, userData };
                } catch (error) {
                    return { success: false, message: 'Error verifying user credentials' };
                }
            }

            async verifyAdminCode(code) {
                // In real implementation, check against server-stored admin codes
                return this.validAdminCodes.includes(code);
            }

            async login(email, password, adminCode) {
                try {
                    // Verify user exists in main app
                    const userVerification = await this.verifyUser(email, password);
                    if (!userVerification.success) {
                        return { success: false, message: userVerification.message };
                    }

                    // Verify admin code
                    const isValidAdmin = await this.verifyAdminCode(adminCode);
                    if (!isValidAdmin) {
                        return { success: false, message: 'Invalid admin authorization code' };
                    }

                    // Create admin session
                    this.currentAdmin = {
                        id: userVerification.userData.email,
                        name: userVerification.userData.name,
                        email: userVerification.userData.email,
                        loginTime: new Date().toISOString(),
                        permissions: this.permissions
                    };

                    this.isLoggedIn = true;
                    this.saveAdminSession();
                    this.logAdminActivity('Admin login successful', 'login');

                    return { success: true, message: 'Login successful' };
                } catch (error) {
                    return { success: false, message: 'Login failed: ' + error.message };
                }
            }

            logout() {
                this.logAdminActivity('Admin logout', 'logout');
                this.currentAdmin = null;
                this.isLoggedIn = false;
                localStorage.removeItem('adminSession');
                this.updateUI();
            }

            async searchUser(email) {
                try {
                    const filename = email.replace('@', '_at_').replace(/\./g, '_dot_') + '.json';
                    const response = await fetch(`${config.apiEndpoint}?folder=users&filename=${filename}`);
                    
                    if (!response.ok) {
                        return { success: false, message: 'User not found' };
                    }
                    
                    const text = await response.text();
                    if (text.includes('error') || text.includes('not found')) {
                        return { success: false, message: 'User not found' };
                    }
                    
                    const userData = JSON.parse(text);
                    this.logAdminActivity(`Searched user: ${email}`, 'search');
                    return { success: true, userData };
                } catch (error) {
                    return { success: false, message: 'Search failed: ' + error.message };
                }
            }

            async updateUser(userId, updates) {
                try {
                    // Load current user data
                    const filename = userId.replace('@', '_at_').replace(/\./g, '_dot_') + '.json';
                    const response = await fetch(`${config.apiEndpoint}?folder=users&filename=${filename}`);
                    
                    if (!response.ok) {
                        return { success: false, message: 'User not found' };
                    }
                    
                    const currentData = JSON.parse(await response.text());
                    
                    // Apply permission restrictions
                    const validatedUpdates = this.validateUpdates(currentData, updates);
                    if (!validatedUpdates.valid) {
                        return { success: false, message: validatedUpdates.message };
                    }

                    // Apply updates
                    const updatedData = { ...currentData, ...validatedUpdates.updates };
                    updatedData.lastUpdated = new Date().toISOString();
                    updatedData.lastUpdatedBy = this.currentAdmin.email;

                    // Save updated data
                    const saveResponse = await fetch(config.apiEndpoint, {
                        method: 'POST',
                        body: new URLSearchParams({
                            folder: 'users',
                            filename: filename,
                            content: JSON.stringify(updatedData, null, 2)
                        })
                    });

                    if (saveResponse.ok) {
                        this.logAdminActivity(`Updated user: ${userId}`, 'update', updates);
                        return { success: true, message: 'User updated successfully' };
                    } else {
                        return { success: false, message: 'Failed to save updates' };
                    }
                } catch (error) {
                    return { success: false, message: 'Update failed: ' + error.message };
                }
            }

            validateUpdates(currentData, updates) {
                const validUpdates = {};
                let errorMessage = '';

                // Validate coin changes (can only decrease)
                if (updates.coins !== undefined) {
                    const newCoins = parseInt(updates.coins);
                    const currentCoins = currentData.coins || 0;
                    
                    if (newCoins > currentCoins) {
                        return { valid: false, message: 'Cannot increase coins. You can only decrease coin amounts.' };
                    }
                    validUpdates.coins = newCoins;
                }

                // Validate earnings changes (can only decrease)
                if (updates.earnings !== undefined) {
                    const newEarnings = parseFloat(updates.earnings);
                    const currentEarnings = currentData.earnings || 0;
                    
                    if (newEarnings > currentEarnings) {
                        return { valid: false, message: 'Cannot increase earnings. You can only decrease earning amounts.' };
                    }
                    validUpdates.earnings = newEarnings;
                    validUpdates.totalEarningsLifetime = newEarnings; // Update lifetime too
                }

                // Allow diamond changes (can increase or decrease)
                if (updates.diamonds !== undefined) {
                    validUpdates.diamonds = parseInt(updates.diamonds);
                }

                // Allow streak changes
                if (updates.streak !== undefined) {
                    validUpdates.streak = parseInt(updates.streak);
                    validUpdates.loginStreak = parseInt(updates.streak);
                }

                // Allow achievement points
                if (updates.achievementPoints !== undefined) {
                    validUpdates.achievementPoints = parseInt(updates.achievementPoints);
                }

                // Allow status changes
                if (updates.isActive !== undefined) {
                    validUpdates.isActive = updates.isActive === 'true';
                }

                if (updates.dailyUnlockedGames !== undefined) {
                    validUpdates.dailyUnlockedGames = updates.dailyUnlockedGames === 'true';
                }

                if (updates.dailyUnlockedVideos !== undefined) {
                    validUpdates.dailyUnlockedVideos = updates.dailyUnlockedVideos === 'true';
                }

                // Allow profile updates
                if (updates.preferredLanguage !== undefined) {
                    validUpdates.preferredLanguage = updates.preferredLanguage;
                }

                if (updates.bio !== undefined) {
                    validUpdates.bio = updates.bio;
                }

                if (updates.location !== undefined) {
                    validUpdates.location = updates.location;
                }

                return { valid: true, updates: validUpdates };
            }

            logAdminActivity(action, type, details = null) {
                const activity = {
                    admin: this.currentAdmin?.email || 'Unknown',
                    action,
                    type,
                    details,
                    timestamp: new Date().toISOString(),
                    ip: 'hidden' // In real app, get actual IP
                };

                // Add to recent activities
                const activities = JSON.parse(localStorage.getItem('adminActivities') || '[]');
                activities.unshift(activity);
                activities.splice(10); // Keep only last 10
                localStorage.setItem('adminActivities', JSON.stringify(activities));

                // Update UI
                this.updateActivityLog();
            }

            updateActivityLog() {
                const activities = JSON.parse(localStorage.getItem('adminActivities') || '[]');
                const container = document.getElementById('adminActivity');
                
                container.innerHTML = '';
                
                if (activities.length === 0) {
                    container.innerHTML = '<div class="text-center text-white/70 py-4">No recent activity</div>';
                    return;
                }

                activities.forEach(activity => {
                    const activityElement = document.createElement('div');
                    activityElement.className = 'p-3 bg-white/10 rounded-lg';
                    
                    const timeAgo = this.getTimeAgo(new Date(activity.timestamp));
                    
                    activityElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-semibold">${activity.action}</span>
                                <div class="text-sm text-white/70">by ${activity.admin}</div>
                            </div>
                            <span class="text-xs text-white/60">${timeAgo}</span>
                        </div>
                    `;
                    
                    container.appendChild(activityElement);
                });
            }

            getTimeAgo(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
                if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                return 'Just now';
            }

            setupEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });

                // User edit form
                document.getElementById('userEditForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleUserUpdate();
                });
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const adminCode = document.getElementById('adminCode').value.trim();

                const submitBtn = document.querySelector('#loginForm button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner"></div>Verifying...';
                submitBtn.disabled = true;

                try {
                    const result = await this.login(email, password, adminCode);
                    
                    if (result.success) {
                        showCustomAlert(result.message, 'success');
                        hideModal('loginModal');
                        this.updateUI();
                    } else {
                        showCustomAlert(result.message, 'error');
                    }
                } catch (error) {
                    showCustomAlert('Login failed: ' + error.message, 'error');
                }

                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }

            async handleUserUpdate() {
                const userId = document.getElementById('editUserId').value;
                const updates = {
                    coins: document.getElementById('editCoins').value,
                    diamonds: document.getElementById('editDiamonds').value,
                    earnings: document.getElementById('editEarnings').value,
                    streak: document.getElementById('editStreak').value,
                    achievementPoints: document.getElementById('editAchievementPoints').value,
                    preferredLanguage: document.getElementById('editLanguage').value,
                    isActive: document.getElementById('editIsActive').value,
                    dailyUnlockedGames: document.getElementById('editDailyGames').value,
                    dailyUnlockedVideos: document.getElementById('editDailyVideos').value,
                    bio: document.getElementById('editBio').value,
                    location: document.getElementById('editLocation').value
                };

                // Remove empty values
                Object.keys(updates).forEach(key => {
                    if (updates[key] === '' || updates[key] === null) {
                        delete updates[key];
                    }
                });

                const submitBtn = document.querySelector('#userEditForm button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner"></div>Saving...';
                submitBtn.disabled = true;

                try {
                    const result = await this.updateUser(userId, updates);
                    
                    if (result.success) {
                        showCustomAlert(result.message, 'success');
                        hideModal('userEditModal');
                        // Refresh user display
                        await searchUser();
                    } else {
                        showCustomAlert(result.message, 'error');
                    }
                } catch (error) {
                    showCustomAlert('Update failed: ' + error.message, 'error');
                }

                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }

            updateUI() {
                if (this.isLoggedIn && this.currentAdmin) {
                    document.getElementById('loginRequired').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminInfo').classList.remove('hidden');
                    document.getElementById('loginButton').classList.add('hidden');
                    
                    document.getElementById('adminName').textContent = this.currentAdmin.name;
                    document.getElementById('adminEmail').textContent = this.currentAdmin.email;
                    document.getElementById('lastLoginTime').textContent = 
                        new Date(this.currentAdmin.loginTime).toLocaleString();
                    
                    this.updateActivityLog();
                } else {
                    document.getElementById('loginRequired').classList.remove('hidden');
                    document.getElementById('adminDashboard').classList.add('hidden');
                    document.getElementById('adminInfo').classList.add('hidden');
                    document.getElementById('loginButton').classList.remove('hidden');
                }
            }
        }

        // Global instance
        const adminPanel = new AdminPanelManager();

        // Global Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showLoginModal() {
            showModal('loginModal');
        }

        function showCustomAlert(message, type = 'info') {
            const alertIcon = document.getElementById('alertIcon');
            const alertMessage = document.getElementById('alertMessage');
            const customAlert = document.getElementById('customAlert');
            
            alertMessage.textContent = message;
            
            switch(type) {
                case 'success':
                    alertIcon.className = 'fas fa-check-circle text-5xl mb-4 text-green-400';
                    break;
                case 'error':
                    alertIcon.className = 'fas fa-exclamation-circle text-5xl mb-4 text-red-400';
                    break;
                case 'warning':
                    alertIcon.className = 'fas fa-exclamation-triangle text-5xl mb-4 text-yellow-400';
                    break;
                default:
                    alertIcon.className = 'fas fa-info-circle text-5xl mb-4 text-blue-400';
            }
            
            customAlert.classList.remove('hidden');
        }

        function hideCustomAlert() {
            document.getElementById('customAlert').classList.add('hidden');
        }

        async function searchUser() {
            const email = document.getElementById('userSearchInput').value.trim();
            
            if (!email) {
                showCustomAlert('Please enter an email address to search', 'warning');
                return;
            }

            if (!adminPanel.isLoggedIn) {
                showCustomAlert('Please login first', 'error');
                return;
            }

            const resultsContainer = document.getElementById('userResults');
            resultsContainer.innerHTML = '<div class="text-center py-4"><div class="spinner"></div>Searching...</div>';

            try {
                const result = await adminPanel.searchUser(email);
                
                if (result.success) {
                    displayUserResult(result.userData);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>Search failed: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayUserResult(userData) {
            const container = document.getElementById('userResults');
            
            container.innerHTML = `
                <div class="glass rounded-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-bold">${userData.name || 'Unknown'}</h4>
                            <p class="text-white/70">${userData.email}</p>
                        </div>
                        <div class="flex space-x-2">
                            <span class="status-badge ${userData.isEmailVerified ? 'verified' : 'unverified'}">
                                <i class="fas fa-${userData.isEmailVerified ? 'check' : 'times'}-circle"></i>
                                ${userData.isEmailVerified ? 'Verified' : 'Unverified'}
                            </span>
                            <span class="status-badge ${userData.isActive ? 'active' : 'inactive'}">
                                <i class="fas fa-${userData.isActive ? 'check' : 'times'}-circle"></i>
                                ${userData.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-400">${userData.coins || 0}</div>
                            <div class="text-sm text-white/70">Coins</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-cyan-400">${userData.diamonds || 0}</div>
                            <div class="text-sm text-white/70">Diamonds</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400">৳${(userData.earnings || 0).toFixed(2)}</div>
                            <div class="text-sm text-white/70">Earnings</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-400">${userData.streak || 0}</div>
                            <div class="text-sm text-white/70">Streak</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <div class="text-sm text-white/70">Join Date</div>
                            <div class="font-semibold">${new Date(userData.joinDate).toLocaleDateString()}</div>
                        </div>
                        <div>
                            <div class="text-sm text-white/70">Last Login</div>
                            <div class="font-semibold">${userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString() : 'Never'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-white/70">Language</div>
                            <div class="font-semibold">${userData.preferredLanguage || 'en'}</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="editUser('${userData.email}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-edit mr-2"></i>Edit User
                        </button>
                        <button onclick="viewUserDetails('${userData.email}')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-eye mr-2"></i>View Details
                        </button>
                    </div>
                </div>
            `;
        }

        function editUser(email) {
            // Load user data into edit form
            adminPanel.searchUser(email).then(result => {
                if (result.success) {
                    const userData = result.userData;
                    adminPanel.originalUserData = userData; // Store for validation
                    
                    // Populate form
                    document.getElementById('editUserId').value = userData.email;
                    document.getElementById('editUserName').textContent = userData.name || 'Unknown';
                    document.getElementById('editCoins').value = userData.coins || 0;
                    document.getElementById('editDiamonds').value = userData.diamonds || 0;
                    document.getElementById('editEarnings').value = userData.earnings || 0;
                    document.getElementById('editStreak').value = userData.streak || 0;
                    document.getElementById('editAchievementPoints').value = userData.achievementPoints || 0;
                    document.getElementById('editLanguage').value = userData.preferredLanguage || 'en';
                    document.getElementById('editIsActive').value = userData.isActive ? 'true' : 'false';
                    document.getElementById('editDailyGames').value = userData.dailyUnlockedGames ? 'true' : 'false';
                    document.getElementById('editDailyVideos').value = userData.dailyUnlockedVideos ? 'true' : 'false';
                    document.getElementById('editBio').value = userData.bio || '';
                    document.getElementById('editLocation').value = userData.location || '';
                    
                    // Populate read-only fields
                    document.getElementById('viewGender').textContent = userData.gender || 'Not specified';
                    document.getElementById('viewJoinDate').textContent = new Date(userData.joinDate).toLocaleDateString();
                    document.getElementById('viewLastLogin').textContent = userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString() : 'Never';
                    
                    showModal('userEditModal');
                }
            });
        }

        function viewUserDetails(email) {
            showCustomAlert('Detailed user view coming soon!', 'info');
        }

        function clearSearch() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userResults').innerHTML = `
                <div class="text-center text-white/70 py-8">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p>Search for users using their email address</p>
                </div>
            `;
        }

        function loadAllUsers() {
            showCustomAlert('Load all users feature requires advanced permissions', 'warning');
        }

        function adminLogout() {
            adminPanel.logout();
            showCustomAlert('Logged out successfully', 'success');
        }

        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

    </script>
</body>
</html>
